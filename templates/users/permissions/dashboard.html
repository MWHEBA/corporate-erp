{% extends "base.html" %}
{% load static %}
{% load utils_extras %}

{% block title %}{{ page_title|default:"إدارة الصلاحيات" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/shared-components.css' %}">
<link rel="stylesheet" href="{% static 'css/unified-components.css' %}">
<style>
:root {
    --permission-primary: var(--bs-primary);
    --permission-success: var(--bs-success);
    --permission-warning: var(--bs-warning);
    --permission-danger: var(--bs-danger);
    --permission-info: var(--bs-info);
}

.permissions-dashboard {
    background: var(--bs-light);
    min-height: calc(100vh - 200px);
}

.stats-overview {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    border-left: 4px solid var(--permission-primary);
    transition: transform 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-card.success { border-left-color: var(--permission-success); }
.stat-card.warning { border-left-color: var(--permission-warning); }
.stat-card.danger { border-left-color: var(--permission-danger); }
.stat-card.info { border-left-color: var(--permission-info); }

.stat-number {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--bs-dark);
    margin-bottom: 0.5rem;
}

.stat-label {
    color: var(--bs-secondary);
    font-size: 0.9rem;
    font-weight: 500;
}

.nav-tabs .nav-link {
    border: none;
    border-radius: 8px 8px 0 0;
    color: var(--bs-secondary);
    font-weight: 500;
    padding: 1rem 1.5rem;
    margin-right: 0.25rem;
}

.nav-tabs .nav-link.active {
    background: white;
    color: var(--permission-primary);
    border-bottom: 3px solid var(--permission-primary);
}

.tab-content {
    background: white;
    border-radius: 0 12px 12px 12px;
    padding: 2rem;
    min-height: 500px;
}

.role-card {
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
}

.role-card:hover {
    border-color: var(--permission-primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.role-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.role-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--bs-dark);
    margin: 0;
}

.role-name {
    font-size: 0.85rem;
    color: var(--bs-secondary);
    font-family: monospace;
    background: var(--bs-light);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
}

.role-stats {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
}

.role-stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--bs-secondary);
}

.user-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.user-row:hover {
    border-color: var(--permission-primary);
    background: var(--bs-light);
}

.user-info h6 {
    margin: 0;
    color: var(--bs-dark);
}

.user-info small {
    color: var(--bs-secondary);
}

.role-badge {
    background: var(--permission-primary);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.role-badge.no-role {
    background: var(--bs-secondary);
}

.activity-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--bs-border-color);
}

.activity-item:last-child {
    border-bottom: none;
}

.activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 1rem;
    font-size: 1.1rem;
}

.activity-icon.create { background: var(--bs-success-bg); color: var(--bs-success); }
.activity-icon.update { background: var(--bs-warning-bg); color: var(--bs-warning); }
.activity-icon.delete { background: var(--bs-danger-bg); color: var(--bs-danger); }
.activity-icon.assign { background: var(--bs-info-bg); color: var(--bs-info); }

.activity-content h6 {
    margin: 0;
    font-size: 0.95rem;
    color: var(--bs-dark);
}

.activity-content small {
    color: var(--bs-secondary);
}

.search-box {
    position: relative;
    margin-bottom: 1.5rem;
}

.search-box input {
    padding-right: 3rem;
}

.search-box .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--bs-secondary);
}

.filter-bar {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    align-items: center;
}

.btn-group-sm .btn {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.modal-header {
    background: var(--permission-primary);
    color: white;
    border-radius: 12px 12px 0 0;
}

.modal-header .btn-close {
    filter: invert(1);
}

.permission-group {
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    margin-bottom: 1rem;
    overflow: hidden;
}

.permission-group-header {
    background: var(--bs-light);
    padding: 1rem;
    border-bottom: 1px solid var(--bs-border-color);
}

.permission-group-header .form-check-label {
    font-weight: 600;
    color: var(--bs-dark);
    cursor: pointer;
}

.permission-list {
    padding: 1rem;
    max-height: 200px;
    overflow-y: auto;
}

.permission-item {
    padding: 0.5rem 0;
}

.permission-item:last-child {
    border-bottom: none;
}

.permission-name {
    font-size: 0.9rem;
    color: var(--bs-dark);
    font-weight: 500;
}

.permission-codename {
    font-size: 0.75rem;
    color: var(--bs-secondary);
    font-family: monospace;
}

.search-results-info {
    margin-bottom: 1rem;
    border-radius: 8px;
}

.refresh-indicator {
    z-index: 1060;
    min-width: 250px;
}

.system-health [data-system] {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--bs-border-color-translucent);
}

.system-health [data-system]:last-child {
    border-bottom: none;
}

.btn-loading .fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* تحسين عرض الأدوار الجديدة */
.role-card[data-role-id] .badge.bg-success {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* تحسين responsive للمودالات */
@media (max-width: 768px) {
    .modal-lg {
        max-width: 95%;
    }
    
    .permission-list {
        max-height: 150px;
    }
    
    .permission-list .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
}

@media (max-width: 768px) {
    .stats-overview {
        padding: 1rem;
    }
    
    .stat-card {
        margin-bottom: 1rem;
    }
    
    .tab-content {
        padding: 1rem;
    }
    
    .role-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .user-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .filter-bar {
        flex-direction: column;
        align-items: stretch;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid permissions-dashboard">
    {% csrf_token %}
    
    <!-- Messages Component -->
    {% include "components/messages.html" %}
    
    <!-- Page Header -->
    {% include "shared/page_header.html" with title=page_title subtitle=page_subtitle icon=page_icon %}
    
    <!-- Navigation Tabs -->
    <ul class="nav nav-tabs" id="permissionsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if current_tab == 'overview' %}active{% endif %}" 
                    id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" 
                    type="button" role="tab">
                <i class="fas fa-tachometer-alt me-2"></i>نظرة عامة
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if current_tab == 'roles' %}active{% endif %}" 
                    id="roles-tab" data-bs-toggle="tab" data-bs-target="#roles" 
                    type="button" role="tab">
                <i class="fas fa-user-tag me-2"></i>إدارة الأدوار
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if current_tab == 'users' %}active{% endif %}" 
                    id="users-tab" data-bs-toggle="tab" data-bs-target="#users" 
                    type="button" role="tab">
                <i class="fas fa-users me-2"></i>إدارة المستخدمين
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if current_tab == 'monitoring' %}active{% endif %}" 
                    id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" 
                    type="button" role="tab">
                <i class="fas fa-shield-alt me-2"></i>المراقبة والأمان
            </button>
        </li>
    </ul>
    
    <!-- Tab Content -->
    <div class="tab-content" id="permissionsTabContent">
        <!-- Overview Tab -->
        <div class="tab-pane fade {% if current_tab == 'overview' %}show active{% endif %}" 
             id="overview" role="tabpanel">
            {% include "users/permissions/tabs/overview_tab.html" %}
        </div>
        
        <!-- Roles Tab -->
        <div class="tab-pane fade {% if current_tab == 'roles' %}show active{% endif %}" 
             id="roles" role="tabpanel">
            {% include "users/permissions/tabs/roles_tab.html" %}
        </div>
        
        <!-- Users Tab -->
        <div class="tab-pane fade {% if current_tab == 'users' %}show active{% endif %}" 
             id="users" role="tabpanel">
            {% include "users/permissions/tabs/users_tab.html" %}
        </div>
        
        <!-- Monitoring Tab -->
        <div class="tab-pane fade {% if current_tab == 'monitoring' %}show active{% endif %}" 
             id="monitoring" role="tabpanel">
            {% include "users/permissions/tabs/monitoring_tab.html" %}
        </div>
    </div>
</div>

<!-- Modals -->
{% include "users/permissions/modals/role_create_modal.html" %}
{% include "users/permissions/modals/role_edit_modal.html" %}
{% include "users/permissions/modals/user_assign_role_modal.html" %}
{% include "users/permissions/modals/user_permissions_modal.html" %}
{% include "users/permissions/modals/edit_user_permissions_modal.html" %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/error-suppressor.js' %}"></script>
<script src="{% static 'js/error-prevention.js' %}"></script>
<script src="{% static 'js/suppress-json-errors.js' %}"></script>
<script src="{% static 'js/permissions-dashboard.js' %}"></script>
<script>
// تمرير معلومات صلاحيات المستخدم لـ JavaScript
window.userCanManageRoles = {{ user_can_manage_roles|yesno:"true,false" }};
window.userCanViewPermissions = {{ user_can_view_permissions|yesno:"true,false" }};
window.userPermissionsInfo = {
    isAdmin: {{ user_permissions_info.is_admin|yesno:"true,false" }},
    isSuperuser: {{ user_permissions_info.is_superuser|yesno:"true,false" }},
    userType: "{{ user_permissions_info.user_type|default:'unknown' }}",
    canManageUsers: {{ user_permissions_info.can_manage_users|yesno:"true,false" }}
};

$(document).ready(function() {
    // Initialize permissions dashboard
    if (typeof PermissionsDashboard !== 'undefined') {
        window.permissionsDashboard = new PermissionsDashboard();
        window.permissionsDashboard.init();
    }
    
    // Handle tab switching with URL updates
    $('#permissionsTabs button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        const tabId = e.target.getAttribute('data-bs-target').replace('#', '');
        const url = new URL(window.location);
        url.searchParams.set('tab', tabId);
        window.history.replaceState({}, '', url);
    });
    
    // Set active tab based on URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab') || 'overview';
    const tabButton = document.querySelector(`#${activeTab}-tab`);
    if (tabButton) {
        const tab = new bootstrap.Tab(tabButton);
        tab.show();
    }
});
</script>
{% endblock %}