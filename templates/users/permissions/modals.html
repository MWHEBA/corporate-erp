<!-- Create Role Modal -->
<div class="modal fade" id="createRoleModal" tabindex="-1" aria-labelledby="createRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createRoleModalLabel">
                    <i class="fas fa-plus me-2"></i>إنشاء دور جديد
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <form id="createRoleForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="roleName" class="form-label">اسم الدور (بالإنجليزية) *</label>
                                <input type="text" class="form-control" id="roleName" name="name" required>
                                <div class="form-text">اسم فريد للدور باللغة الإنجليزية (مثل: manager, accountant)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="roleDisplayName" class="form-label">الاسم المعروض *</label>
                                <input type="text" class="form-control" id="roleDisplayName" name="display_name" required>
                                <div class="form-text">الاسم الذي سيظهر للمستخدمين</div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="roleDescription" class="form-label">الوصف</label>
                        <textarea class="form-control" id="roleDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الصلاحيات</label>
                        <div id="permissionsContainer" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="loading-spinner"></div>
                                <p class="mt-2">جاري تحميل الصلاحيات...</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="createRole()">
                    <i class="fas fa-save me-2"></i>إنشاء الدور
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Role Modal -->
<div class="modal fade" id="editRoleModal" tabindex="-1" aria-labelledby="editRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRoleModalLabel">
                    <i class="fas fa-edit me-2"></i>تعديل الدور
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <form id="editRoleForm">
                    <input type="hidden" id="editRoleId" name="role_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editRoleName" class="form-label">اسم الدور</label>
                                <input type="text" class="form-control" id="editRoleName" name="name" readonly>
                                <div class="form-text">لا يمكن تغيير اسم الدور</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editRoleDisplayName" class="form-label">الاسم المعروض *</label>
                                <input type="text" class="form-control" id="editRoleDisplayName" name="display_name" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editRoleDescription" class="form-label">الوصف</label>
                        <textarea class="form-control" id="editRoleDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editRoleIsActive" name="is_active">
                            <label class="form-check-label" for="editRoleIsActive">
                                الدور نشط
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الصلاحيات</label>
                        <div id="editPermissionsContainer" style="max-height: 300px; overflow-y: auto;">
                            <div class="text-center py-3">
                                <div class="loading-spinner"></div>
                                <p class="mt-2">جاري تحميل الصلاحيات...</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="updateRole()">
                    <i class="fas fa-save me-2"></i>حفظ التغييرات
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Permissions Modal - Enhanced for Custom Permissions -->
<div class="modal fade" id="userPermissionsModal" tabindex="-1" aria-labelledby="userPermissionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userPermissionsModalLabel">
                    <i class="fas fa-shield-alt me-2"></i>صلاحيات المستخدم: <span id="modalUserName"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <!-- User Info Card -->
                <div class="user-info-card mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <label>الدور الحالي:</label>
                            <span id="modalUserRole" class="badge bg-primary ms-2"></span>
                        </div>
                        <div class="col-md-4">
                            <label>الصلاحيات المخصصة:</label>
                            <span id="modalCustomPermissionsCount" class="badge bg-info ms-2">0/42</span>
                        </div>
                        <div class="col-md-4">
                            <label>آخر تحديث:</label>
                            <small id="modalLastUpdate" class="text-muted ms-2">غير محدد</small>
                        </div>
                    </div>
                </div>

                <!-- Permissions Tabs -->
                <ul class="nav nav-tabs" id="userPermissionsTabs">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#rolePermissions">
                            <i class="fas fa-users-cog"></i> صلاحيات الدور
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#customPermissions">
                            <i class="fas fa-user-cog"></i> صلاحيات مخصصة
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#permissionsSummary">
                            <i class="fas fa-chart-pie"></i> ملخص الصلاحيات
                        </button>
                    </li>
                </ul>

                <div class="tab-content mt-3">
                    <!-- Role Permissions Tab -->
                    <div class="tab-pane fade show active" id="rolePermissions">
                        <div id="rolePermissionsContent">
                            <div class="text-center py-3">
                                <div class="loading-spinner"></div>
                                <p class="mt-2">جاري تحميل صلاحيات الدور...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Permissions Tab -->
                    <div class="tab-pane fade" id="customPermissions">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>الصلاحيات المخصصة للمستخدم</h6>
                            <button class="btn btn-sm btn-primary" id="addCustomPermissionBtn">
                                <i class="fas fa-plus"></i> إضافة صلاحية
                            </button>
                        </div>
                        <div id="customPermissionsContent">
                            <div class="text-center py-3">
                                <div class="loading-spinner"></div>
                                <p class="mt-2">جاري تحميل الصلاحيات المخصصة...</p>
                            </div>
                        </div>
                    </div>

                    <!-- Permissions Summary Tab -->
                    <div class="tab-pane fade" id="permissionsSummary">
                        <div id="permissionsSummaryContent">
                            <div class="text-center py-3">
                                <div class="loading-spinner"></div>
                                <p class="mt-2">جاري تحميل ملخص الصلاحيات...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-info" onclick="exportUserPermissions()">
                    <i class="fas fa-download"></i> تصدير
                </button>
                <button type="button" class="btn btn-outline-warning" onclick="copyPermissionsFromUser()">
                    <i class="fas fa-copy"></i> نسخ من مستخدم آخر
                </button>
                <button type="button" class="btn btn-success" id="saveUserPermissions" style="display: none;">
                    <i class="fas fa-save"></i> حفظ التغييرات
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Role Modal -->
<div class="modal fade" id="assignRoleModal" tabindex="-1" aria-labelledby="assignRoleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="assignRoleModalLabel">
                    <i class="fas fa-user-cog me-2"></i>تعيين دور للمستخدم
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <form id="assignRoleForm">
                    <input type="hidden" id="assignUserId" name="user_id">
                    <div class="mb-3">
                        <label class="form-label">المستخدم</label>
                        <div id="assignUserInfo" class="p-3 bg-light rounded">
                            <!-- User info will be populated here -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="assignRoleSelect" class="form-label">الدور الجديد</label>
                        <select class="form-select" id="assignRoleSelect" name="role_id">
                            <option value="">إزالة الدور</option>
                            {% for role in available_roles %}
                            <option value="{{ role.id }}">{{ role.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="assignRole()">
                    <i class="fas fa-save me-2"></i>تعيين الدور
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Assign Roles Modal -->
<div class="modal fade" id="bulkAssignModal" tabindex="-1" aria-labelledby="bulkAssignModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkAssignModalLabel">
                    <i class="fas fa-users-cog me-2"></i>تعيين جماعي للأدوار
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <form id="bulkAssignForm">
                    <div class="mb-3">
                        <label class="form-label">المستخدمين المحددين</label>
                        <div id="selectedUsersInfo" class="p-3 bg-light rounded">
                            <!-- Selected users info will be populated here -->
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="bulkRoleSelect" class="form-label">الدور المراد تعيينه</label>
                        <select class="form-select" id="bulkRoleSelect" name="role_id" required>
                            <option value="">اختر الدور</option>
                            {% for role in available_roles %}
                            <option value="{{ role.id }}">{{ role.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        سيتم تعيين الدور المحدد لجميع المستخدمين المحددين. هذا الإجراء سيحل محل أدوارهم الحالية.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" onclick="performBulkAssign()">
                    <i class="fas fa-save me-2"></i>تعيين الأدوار
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Compare Roles Modal -->
<div class="modal fade" id="compareRolesModal" tabindex="-1" aria-labelledby="compareRolesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="compareRolesModalLabel">
                    <i class="fas fa-balance-scale me-2"></i>مقارنة الأدوار
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="compareRole1" class="form-label">الدور الأول</label>
                        <select class="form-select" id="compareRole1">
                            <option value="">اختر الدور الأول</option>
                            {% for role in available_roles %}
                            <option value="{{ role.id }}">{{ role.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="compareRole2" class="form-label">الدور الثاني</label>
                        <select class="form-select" id="compareRole2">
                            <option value="">اختر الدور الثاني</option>
                            {% for role in available_roles %}
                            <option value="{{ role.id }}">{{ role.display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="text-center mb-3">
                    <button type="button" class="btn btn-primary" onclick="performRoleComparison()">
                        <i class="fas fa-search me-2"></i>مقارنة الأدوار
                    </button>
                </div>
                <div id="comparisonResults">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-balance-scale fa-3x mb-3"></i>
                        <br>اختر دورين لبدء المقارنة
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteConfirmModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>تأكيد الحذف
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                    <h5>هل أنت متأكد من حذف هذا الدور؟</h5>
                    <p id="deleteConfirmMessage" class="text-muted"></p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        هذا الإجراء لا يمكن التراجع عنه!
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>حذف الدور
                </button>
            </div>
        </div>
    </div>
</div>