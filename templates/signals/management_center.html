{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load utils_extras %}

{% block title %}{{ title }} | {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/shared-components.css' %}">
<link rel="stylesheet" href="{% static 'css/unified-components.css' %}">
<link rel="stylesheet" href="{% static 'css/governance.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% csrf_token %}
    
    <!-- Page Header -->
    {% include "shared/page_header.html" with title=title subtitle=subtitle icon=icon breadcrumb_items=breadcrumb_items %}
    
    <!-- Signals Overview -->
    <div class="section-container">
        <h5 class="section-title"><i class="fas fa-broadcast-tower me-2"></i>نظرة عامة على الإشارات</h5>
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-primary">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-signal"></i></div>
                        <div class="stats-card-title">إشارات نشطة</div>
                        <div class="stats-card-value">{{ active_signals }}</div>
                        <div class="stats-card-unit">إشارة</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-success">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="stats-card-title">إشارات ناجحة</div>
                        <div class="stats-card-value">{{ successful_today }}</div>
                        <div class="stats-card-unit">اليوم</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-danger">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stats-card-title">إشارات فاشلة</div>
                        <div class="stats-card-value">{{ failed_today }}</div>
                        <div class="stats-card-unit">اليوم</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-warning">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-pause-circle"></i></div>
                        <div class="stats-card-title">إشارات معطلة</div>
                        <div class="stats-card-value">{{ disabled_signals }}</div>
                        <div class="stats-card-unit">إشارة</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Signals Management -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-list me-2"></i>إدارة الإشارات النشطة
        </h5>
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="signalsTable">
                            <thead>
                                <tr>
                                    <th class="text-center">اسم الإشارة</th>
                                    <th class="text-center">الموديول</th>
                                    <th class="text-center">النوع</th>
                                    <th class="text-center">الأولوية</th>
                                    <th class="text-center">آخر تنفيذ</th>
                                    <th class="text-center">معدل النجاح</th>
                                    <th class="text-center">الحالة</th>
                                    <th class="text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for signal in signals_data %}
                                <tr>
                                    <td class="text-center"><code>{{ signal.signal_name }}</code></td>
                                    <td class="text-center">{{ signal.module_name|title }}</td>
                                    <td class="text-center"><span class="badge bg-info">{{ signal.signal_type }}</span></td>
                                    <td class="text-center"><span class="badge bg-{{ signal.priority_class }}">{{ signal.priority }}</span></td>
                                    <td class="text-center">
                                        {% if signal.last_execution %}
                                            {{ signal.last_execution|timesince }} مضت
                                        {% else %}
                                            لم يتم التنفيذ بعد
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="progress" style="height: 20px;">
                                            {% if signal.success_rate >= 95 %}
                                                <div class="progress-bar bg-success" style="width: {{ signal.success_rate }}%">{{ signal.success_rate }}%</div>
                                            {% elif signal.success_rate >= 80 %}
                                                <div class="progress-bar bg-warning" style="width: {{ signal.success_rate }}%">{{ signal.success_rate }}%</div>
                                            {% else %}
                                                <div class="progress-bar bg-danger" style="width: {{ signal.success_rate }}%">{{ signal.success_rate }}%</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td class="text-center"><span class="badge bg-{{ signal.status_class }}">{{ signal.status_display }}</span></td>
                                    <td class="text-center">
                                        {% if signal.status == 'ACTIVE' %}
                                            <button class="btn btn-outline-warning btn-sm" onclick="toggleSignal('{{ signal.signal_name }}', false)">
                                                <i class="fas fa-pause"></i>
                                            </button>
                                        {% else %}
                                            <button class="btn btn-outline-success btn-sm" onclick="toggleSignal('{{ signal.signal_name }}', true)">
                                                <i class="fas fa-play"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-outline-info btn-sm" onclick="viewSignalDetails('{{ signal.signal_name }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-info-circle me-2"></i>لا توجد إشارات مسجلة. استخدم الأمر <code>python manage.py register_signals</code> لتسجيل الإشارات.
                                    </td>
                                </tr>
                                {% endfor %}
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Signal Performance Monitoring -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-chart-line me-2"></i>مراقبة أداء الإشارات
        </h5>
        <div class="row">
                <div class="col-lg-8 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-clock me-2"></i>أوقات التنفيذ (آخر 24 ساعة)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th class="text-center">الإشارة</th>
                                            <th class="text-center">متوسط الوقت</th>
                                            <th class="text-center">أقصى وقت</th>
                                            <th class="text-center">عدد التنفيذات</th>
                                            <th class="text-center">الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for perf in performance_data %}
                                        <tr>
                                            <td class="text-center"><code>{{ perf.signal_name }}</code></td>
                                            <td class="text-center">{{ perf.avg_time|floatformat:2 }} ms</td>
                                            <td class="text-center">{{ perf.max_time }} ms</td>
                                            <td class="text-center">{{ perf.count }}</td>
                                            <td class="text-center">
                                                {% if perf.performance_status == 'excellent' %}
                                                    <span class="badge bg-success">ممتاز</span>
                                                {% elif perf.performance_status == 'warning' %}
                                                    <span class="badge bg-warning">متوسط</span>
                                                {% else %}
                                                    <span class="badge bg-danger">بطيء</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>لا توجد بيانات أداء متاحة
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>تنبيهات الأداء
                            </h6>
                        </div>
                        <div class="card-body">
                            {% if active_alerts %}
                                {% for alert in active_alerts %}
                                <div class="alert alert-{{ alert.severity|lower }} alert-dismissible fade show" role="alert">
                                    <strong>{{ alert.get_severity_display }}:</strong> {{ alert.message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-success" role="alert">
                                    <i class="fas fa-check-circle me-2"></i><strong>ممتاز!</strong> جميع الإشارات تعمل بشكل طبيعي
                                </div>
                            {% endif %}
                        </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Permissions Management -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-user-shield me-2"></i>إدارة الأذونات والصلاحيات
        </h5>
        <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-users me-2"></i>الأدوار النشطة
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                {% for role in roles_data %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ role.name }}</strong>
                                        <br><small class="text-muted">{{ role.permission_count }} صلاحية</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-primary me-2">{{ role.user_count }} مستخدمين</span>
                                        <button class="btn btn-outline-primary btn-sm" onclick="editRole('{{ role.name }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>لا توجد أدوار محددة
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-key me-2"></i>الصلاحيات الحرجة
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>إدارة النظام</strong>
                                        <br><small class="text-muted">تعديل إعدادات النظام</small>
                                    </div>
                                    <span class="badge bg-danger">3 مستخدمين</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>إدارة المستخدمين</strong>
                                        <br><small class="text-muted">إضافة وحذف المستخدمين</small>
                                    </div>
                                    <span class="badge bg-warning">5 مستخدمين</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>إدارة النسخ الاحتياطي</strong>
                                        <br><small class="text-muted">إنشاء واستعادة النسخ</small>
                                    </div>
                                    <span class="badge bg-info">2 مستخدمين</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>عرض التقارير المالية</strong>
                                        <br><small class="text-muted">الوصول للتقارير الحساسة</small>
                                    </div>
                                    <span class="badge bg-success">8 مستخدمين</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="section-container">
        <h5 class="section-title"><i class="fas fa-bolt me-2"></i>إجراءات سريعة</h5>
        <div class="row">
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-success w-100" onclick="enableAllSignals()">
                    <i class="fas fa-play me-2"></i>تفعيل جميع الإشارات
                </button>
            </div>
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-warning w-100" onclick="pauseCriticalSignals()">
                    <i class="fas fa-pause me-2"></i>إيقاف الإشارات الحرجة
                </button>
            </div>
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-info w-100" onclick="exportSignalsReport()">
                    <i class="fas fa-download me-2"></i>تقرير الإشارات
                </button>
            </div>
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-primary w-100" onclick="refreshSignalsStatus()">
                    <i class="fas fa-sync me-2"></i>تحديث الحالة
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/global-table.js' %}"></script>
<script>
$(document).ready(function() {
    // Initialize DataTable
    if (typeof GlobalTableManager !== 'undefined') {
        GlobalTableManager.initializeTable('signalsTable', {
            order: [[4, 'desc']], // Sort by last execution
            columnDefs: [
                { targets: -1, orderable: false }, // Actions column
                { targets: [5], orderable: false }  // Progress bars
            ],
            language: {
                "search": "البحث:",
                "lengthMenu": "عرض _MENU_ إشارة",
                "info": "عرض _START_ إلى _END_ من _TOTAL_ إشارة",
                "paginate": {
                    "first": "الأول",
                    "last": "الأخير",
                    "next": "التالي",
                    "previous": "السابق"
                }
            }
        });
    }
    
    // Auto-refresh signals status every 30 seconds
    setInterval(refreshSignalsStatus, 30000);
});

function toggleSignal(signalName, enable) {
    const action = enable ? 'تفعيل' : 'إيقاف';
    Swal.fire({
        title: `هل أنت متأكد من ${action} الإشارة؟`,
        text: signalName,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'نعم، ' + action,
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            toastr.info(`جاري ${action} الإشارة ${signalName}...`);
            // TODO: Make AJAX call to toggle the signal
            setTimeout(() => {
                toastr.success(`تم ${action} الإشارة بنجاح`);
                location.reload();
            }, 1000);
        }
    });
}

function viewSignalDetails(signalName) {
    Swal.fire({
        title: 'تفاصيل الإشارة',
        html: `<p class="text-start">اسم الإشارة: <code>${signalName}</code></p>
               <p class="text-muted">سيتم إضافة المزيد من التفاصيل قريباً</p>`,
        icon: 'info',
        confirmButtonText: 'حسناً'
    });
}

function editRole(roleName) {
    toastr.info(`تعديل الدور: ${roleName}`);
    // TODO: Navigate to role editing page
}

function enableAllSignals() {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم تفعيل جميع الإشارات المعطلة',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، فعّل الكل',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            toastr.info('جاري تفعيل جميع الإشارات...');
            // TODO: Make AJAX call
        }
    });
}

function pauseCriticalSignals() {
    Swal.fire({
        title: 'تحذير!',
        text: 'إيقاف الإشارات الحرجة قد يؤثر على النظام. هل أنت متأكد؟',
        icon: 'error',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'نعم، أوقف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            toastr.warning('جاري إيقاف الإشارات الحرجة...');
            // TODO: Make AJAX call
        }
    });
}

function exportSignalsReport() {
    toastr.info('جاري تصدير تقرير الإشارات...');
    // TODO: Make AJAX call to export report
}

function refreshSignalsStatus() {
    toastr.info('جاري تحديث حالة الإشارات...');
    setTimeout(() => {
        location.reload();
    }, 500);
}
</script>
{% endblock %}