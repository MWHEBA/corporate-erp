{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load utils_extras %}

{% block title %}{{ title }} | {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/shared-components.css' %}">
<link rel="stylesheet" href="{% static 'css/unified-components.css' %}">
<link rel="stylesheet" href="{% static 'css/governance.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% csrf_token %}
    
    <!-- Page Header -->
    {% include "shared/page_header.html" with title=title subtitle=subtitle icon=icon %}
    
    <!-- Security Overview -->
    <div class="section-container">
        <h5 class="section-title"><i class="fas fa-shield-alt me-2"></i>نظرة عامة على الأمان</h5>
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-success">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-lock"></i></div>
                        <div class="stats-card-title">السياسات النشطة</div>
                        <div class="stats-card-value">{{ security_overview.active_policies }}</div>
                        <div class="stats-card-unit">سياسة</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-info">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-key"></i></div>
                        <div class="stats-card-title">مفاتيح التشفير</div>
                        <div class="stats-card-value">{{ security_overview.active_keys }}</div>
                        <div class="stats-card-unit">مفتاح</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-warning">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="stats-card-title">انتهاكات اليوم</div>
                        <div class="stats-card-value">{{ security_overview.today_violations }}</div>
                        <div class="stats-card-unit">انتهاك</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-primary">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-user-shield"></i></div>
                        <div class="stats-card-title">مستوى الأمان</div>
                        <div class="stats-card-value">{{ security_overview.security_level }}</div>
                        <div class="stats-card-unit">مستوى</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Security Policies Management -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-file-shield me-2"></i>إدارة السياسات الأمنية
        </h5>
        <div>
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-user-lock me-2"></i>سياسات المصادقة
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                {% for policy in auth_policies %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ policy.name }}</strong>
                                        <br><small class="text-muted">{{ policy.description }}</small>
                                    </div>
                                    <span class="badge {% if policy.is_enabled %}bg-success{% else %}bg-secondary{% endif %}">{{ policy.status }}</span>
                                </div>
                                {% empty %}
                                <div class="list-group-item text-center text-muted">
                                    لا توجد سياسات مصادقة محددة
                                </div>
                                {% endfor %}
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="editAuthPolicies()">
                                    <i class="fas fa-edit me-1"></i>تعديل السياسات
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-network-wired me-2"></i>سياسات الشبكة
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                {% for policy in network_policies %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ policy.name }}</strong>
                                        <br><small class="text-muted">{{ policy.description }}</small>
                                    </div>
                                    <span class="badge {% if policy.is_enabled %}bg-success{% else %}bg-secondary{% endif %}">{{ policy.status }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" onclick="editNetworkPolicies()">
                                    <i class="fas fa-edit me-1"></i>تعديل السياسات
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Encryption Management -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-key me-2"></i>إدارة التشفير
        </h5>
        <div>
            <div class="row">
                <div class="col-lg-8 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-key me-2"></i>مفاتيح التشفير النشطة
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th class="text-center">اسم المفتاح</th>
                                            <th class="text-center">النوع</th>
                                            <th class="text-center">تاريخ الإنشاء</th>
                                            <th class="text-center">تاريخ الانتهاء</th>
                                            <th class="text-center">الحالة</th>
                                            <th class="text-center">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for key in encryption_keys %}
                                        <tr>
                                            <td class="text-center"><code>{{ key.key_name }}</code></td>
                                            <td class="text-center">{{ key.key_type }}</td>
                                            <td class="text-center">{{ key.created_at|date:"Y-m-d" }}</td>
                                            <td class="text-center">{{ key.expires_at|date:"Y-m-d" }}</td>
                                            <td class="text-center">
                                                <span class="badge {% if key.status_code == 'ACTIVE' %}bg-success{% elif key.status_code == 'EXPIRING_SOON' %}bg-warning{% else %}bg-secondary{% endif %}">
                                                    {{ key.status }}
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                {% if key.status_code == 'ACTIVE' or key.status_code == 'EXPIRING_SOON' %}
                                                <button class="btn btn-outline-warning btn-sm" onclick="rotateKey({{ key.id }}, '{{ key.key_name }}')">
                                                    <i class="fas fa-sync me-1"></i>تدوير
                                                </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">لا توجد مفاتيح تشفير</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-plus me-2"></i>إنشاء مفتاح جديد
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="newKeyForm">
                                <div class="mb-3">
                                    <label class="form-label">اسم المفتاح</label>
                                    <input type="text" class="form-control" id="keyName" placeholder="مثال: BACKUP_KEY">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">نوع التشفير</label>
                                    <select class="form-select" id="keyType">
                                        <option value="AES-256">AES-256</option>
                                        <option value="AES-128">AES-128</option>
                                        <option value="RSA-2048">RSA-2048</option>
                                        <option value="RSA-4096">RSA-4096</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">مدة الصلاحية (أشهر)</label>
                                    <input type="number" class="form-control" id="keyDuration" value="12" min="1" max="24">
                                </div>
                                <button type="button" class="btn btn-primary w-100" onclick="generateNewKey()">
                                    <i class="fas fa-key me-1"></i>إنشاء المفتاح
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Security Monitoring -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-eye me-2"></i>مراقبة الأمان
        </h5>
        <div>
            <div class="row">
                <div class="col-lg-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-chart-line me-2"></i>إحصائيات الأمان
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6 mb-3">
                                    <div class="metric-box">
                                        <div class="metric-value text-success">{{ security_stats.successful_logins|default:0 }}</div>
                                        <div class="metric-label">تسجيلات دخول ناجحة</div>
                                    </div>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="metric-box">
                                        <div class="metric-value text-warning">{{ security_stats.failed_logins|default:0 }}</div>
                                        <div class="metric-label">محاولات فاشلة</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-box">
                                        <div class="metric-value text-info">{{ security_stats.active_sessions|default:0 }}</div>
                                        <div class="metric-label">جلسات نشطة</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="metric-box">
                                        <div class="metric-value text-danger">{{ security_stats.locked_accounts|default:0 }}</div>
                                        <div class="metric-label">حسابات مقفلة</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-shield-alt me-2"></i>حالة الحماية
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="list-group list-group-flush">
                                {% for protection in protection_status %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="{{ protection.icon }} me-2"></i>
                                        <strong>{{ protection.name }}</strong>
                                    </div>
                                    <span class="badge {{ protection.status_class }}">{{ protection.status }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="section-container">
        <h5 class="section-title"><i class="fas fa-bolt me-2"></i>إجراءات سريعة</h5>
        <div class="row">
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-primary w-100" onclick="runSecurityScan()">
                    <i class="fas fa-search me-2"></i>فحص أمني شامل
                </button>
            </div>
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-warning w-100" onclick="rotateAllKeys()">
                    <i class="fas fa-sync me-2"></i>تدوير جميع المفاتيح
                </button>
            </div>
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-info w-100" onclick="exportSecurityReport()">
                    <i class="fas fa-download me-2"></i>تقرير الأمان
                </button>
            </div>
            <div class="col-md-3 mb-2">
                <button class="btn btn-outline-success w-100" onclick="updateSecurityPolicies()">
                    <i class="fas fa-shield-alt me-2"></i>تحديث السياسات
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/global-table.js' %}"></script>
<script>
$(document).ready(function() {
    // Initialize collapsible sections
    $('.section-title[data-bs-toggle="collapse"]').on('click', function() {
        const icon = $(this).find('.fa-chevron-down, .fa-chevron-up');
        icon.toggleClass('fa-chevron-down fa-chevron-up');
    });
});

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

function editAuthPolicies() {
    toastr.info('سيتم فتح نافذة تعديل سياسات المصادقة قريباً');
}

function editNetworkPolicies() {
    toastr.info('سيتم فتح نافذة تعديل سياسات الشبكة قريباً');
}

function rotateKey(keyId, keyName) {
    Swal.fire({
        title: 'تدوير المفتاح',
        text: `هل أنت متأكد من تدوير المفتاح ${keyName}؟`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'نعم، قم بالتدوير',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            toastr.info('جاري تدوير المفتاح...');
            
            fetch(`/governance/policies/key/${keyId}/rotate/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('نجح!', data.message, 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('خطأ!', data.error || 'حدث خطأ أثناء تدوير المفتاح', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('خطأ!', 'حدث خطأ في الاتصال بالخادم', 'error');
            });
        }
    });
}

function generateNewKey() {
    const keyName = document.getElementById('keyName').value;
    const keyType = document.getElementById('keyType').value;
    const keyDuration = document.getElementById('keyDuration').value;
    
    if (!keyName) {
        toastr.error('يرجى إدخال اسم المفتاح');
        return;
    }
    
    Swal.fire({
        title: 'إنشاء مفتاح جديد',
        text: `إنشاء مفتاح: ${keyName} (${keyType})`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'نعم، قم بالإنشاء',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            toastr.info('جاري إنشاء المفتاح...');
            
            fetch('/governance/policies/key/create/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    key_name: keyName,
                    key_type: keyType,
                    duration_months: parseInt(keyDuration)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire('نجح!', data.message, 'success').then(() => {
                        document.getElementById('newKeyForm').reset();
                        location.reload();
                    });
                } else {
                    Swal.fire('خطأ!', data.error || 'حدث خطأ أثناء إنشاء المفتاح', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('خطأ!', 'حدث خطأ في الاتصال بالخادم', 'error');
            });
        }
    });
}

function runSecurityScan() {
    Swal.fire({
        title: 'فحص أمني شامل',
        text: 'هل تريد تشغيل الفحص الأمني الشامل؟',
        icon: 'info',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'نعم، ابدأ الفحص',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            toastr.info('جاري تشغيل الفحص الأمني...');
            
            fetch('/governance/policies/scan/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const results = data.results;
                    let message = `تم العثور على ${results.issues_found} مشكلة`;
                    
                    if (results.warnings.length > 0) {
                        message += '\n\nالتحذيرات:\n' + results.warnings.join('\n');
                    }
                    
                    if (results.recommendations.length > 0) {
                        message += '\n\nالتوصيات:\n' + results.recommendations.join('\n');
                    }
                    
                    Swal.fire({
                        title: 'نتائج الفحص',
                        text: message,
                        icon: results.issues_found > 0 ? 'warning' : 'success',
                        confirmButtonText: 'حسناً'
                    });
                } else {
                    Swal.fire('خطأ!', data.error || 'حدث خطأ أثناء الفحص', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('خطأ!', 'حدث خطأ في الاتصال بالخادم', 'error');
            });
        }
    });
}

function rotateAllKeys() {
    Swal.fire({
        title: 'تدوير جميع المفاتيح',
        text: 'هل أنت متأكد من تدوير جميع المفاتيح؟ هذا قد يؤثر على النظام مؤقتاً.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، قم بالتدوير',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            toastr.info('جاري تدوير جميع المفاتيح...');
            
            fetch('/governance/policies/keys/rotate-all/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = data.message;
                    if (data.errors && data.errors.length > 0) {
                        message += '\n\nأخطاء:\n' + data.errors.join('\n');
                    }
                    Swal.fire('نجح!', message, 'success').then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire('خطأ!', data.error || 'حدث خطأ أثناء تدوير المفاتيح', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('خطأ!', 'حدث خطأ في الاتصال بالخادم', 'error');
            });
        }
    });
}

function exportSecurityReport() {
    toastr.info('جاري تصدير تقرير الأمان...');
    window.location.href = '/governance/policies/report/export/';
}

function updateSecurityPolicies() {
    Swal.fire({
        title: 'تحديث السياسات',
        text: 'هل تريد تحديث جميع السياسات الأمنية؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'نعم، قم بالتحديث',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            toastr.success('تم تحديث السياسات الأمنية بنجاح');
            setTimeout(() => location.reload(), 1500);
        }
    });
}
</script>
{% endblock %}