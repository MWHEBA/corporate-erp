{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load utils_extras %}

{% block title %}{{ title }} | {{ block.super }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/shared-components.css' %}">
<link rel="stylesheet" href="{% static 'css/unified-components.css' %}">
<link rel="stylesheet" href="{% static 'css/governance.css' %}">
<style>
.report-builder {
    min-height: 400px;
}
.field-selector {
    max-height: 300px;
    overflow-y: auto;
}
.selected-fields {
    min-height: 200px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 15px;
}
.field-item {
    cursor: pointer;
    padding: 8px 12px;
    margin: 2px 0;
    border-radius: 4px;
    transition: background-color 0.2s;
}
.field-item:hover {
    background-color: var(--bs-light);
}
.selected-field {
    background-color: var(--bs-primary);
    color: white;
    padding: 5px 10px;
    margin: 2px;
    border-radius: 15px;
    display: inline-block;
}
.chart-preview {
    min-height: 250px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    {% csrf_token %}
    
    <!-- Page Header -->
    {% include "shared/page_header.html" with title=title subtitle=subtitle icon=icon %}
    
    <!-- Reports Overview -->
    <div class="section-container">
        <h5 class="section-title"><i class="fas fa-chart-bar me-2"></i>نظرة عامة على التقارير</h5>
        <div class="row">
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-primary">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="stats-card-title">التقارير المحفوظة</div>
                        <div class="stats-card-value">{{ stats.total_reports }}</div>
                        <div class="stats-card-unit">تقرير</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-success">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-clock"></i></div>
                        <div class="stats-card-title">التقارير المجدولة</div>
                        <div class="stats-card-value">{{ stats.scheduled_reports }}</div>
                        <div class="stats-card-unit">تقرير</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-info">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-download"></i></div>
                        <div class="stats-card-title">تم تصديرها اليوم</div>
                        <div class="stats-card-value">{{ stats.executions_today }}</div>
                        <div class="stats-card-unit">تقرير</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="stats-card stats-card-warning">
                    <div class="stats-card-body">
                        <div class="stats-card-icon"><i class="fas fa-users"></i></div>
                        <div class="stats-card-title">المستخدمين النشطين</div>
                        <div class="stats-card-value">{{ stats.active_users }}</div>
                        <div class="stats-card-unit">مستخدم</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Report Builder -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-tools me-2"></i>منشئ التقارير المخصصة
        </h5>
        <div class="card">
            <div class="card-body report-builder">
                    <div class="row">
                        <!-- Data Source Selection -->
                        <div class="col-lg-3 mb-3">
                            <h6><i class="fas fa-database me-2"></i>مصدر البيانات</h6>
                            <select class="form-select mb-3" id="dataSource" onchange="loadFields()">
                                <option value="">اختر مصدر البيانات</option>
                                <option value="customers">العملاء</option>
                                <option value="sales">فواتير المبيعات</option>
                                <option value="purchases">فواتير المشتريات</option>
                                <option value="payments">المدفوعات</option>
                                <option value="employees">الموظفين</option>
                                <option value="journal_entries">القيود اليومية</option>
                                <option value="products">المنتجات</option>
                                <option value="suppliers">الموردين</option>
                            </select>
                            
                            <h6><i class="fas fa-list me-2"></i>الحقول المتاحة</h6>
                            <div class="field-selector" id="availableFields">
                                <div class="text-muted text-center py-3">
                                    <i class="fas fa-arrow-up me-2"></i>اختر مصدر البيانات أولاً
                                </div>
                            </div>
                        </div>
                        
                        <!-- Selected Fields -->
                        <div class="col-lg-4 mb-3">
                            <h6><i class="fas fa-check-square me-2"></i>الحقول المختارة</h6>
                            <div class="selected-fields" id="selectedFields">
                                <div class="text-muted text-center py-4">
                                    <i class="fas fa-mouse-pointer me-2"></i>اسحب الحقول هنا أو انقر عليها
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <h6><i class="fas fa-filter me-2"></i>المرشحات</h6>
                                <div id="filtersContainer">
                                    <button class="btn btn-outline-primary btn-sm" onclick="addFilter()">
                                        <i class="fas fa-plus me-1"></i>إضافة مرشح
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chart Configuration -->
                        <div class="col-lg-5 mb-3">
                            <h6><i class="fas fa-chart-pie me-2"></i>نوع التقرير</h6>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <select class="form-select" id="reportType" onchange="debouncedUpdatePreview()">
                                        <option value="table">جدول</option>
                                        <option value="bar">رسم بياني عمودي</option>
                                        <option value="pie">رسم دائري</option>
                                        <option value="line">رسم خطي</option>
                                        <option value="summary">ملخص إحصائي</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select class="form-select" id="groupBy">
                                        <option value="">بدون تجميع</option>
                                        <option value="date">حسب التاريخ</option>
                                        <option value="month">حسب الشهر</option>
                                        <option value="category">حسب الفئة</option>
                                    </select>
                                </div>
                            </div>
                            
                            <h6><i class="fas fa-eye me-2"></i>معاينة التقرير</h6>
                            <div class="chart-preview" id="chartPreview">
                                <div class="text-muted">
                                    <i class="fas fa-chart-bar fa-3x mb-2"></i>
                                    <br>اختر الحقول ونوع التقرير لرؤية المعاينة
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <hr>
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-primary" onclick="generateReport()">
                                    <i class="fas fa-play me-1"></i>إنشاء التقرير
                                </button>
                                <button class="btn btn-success" onclick="saveReport()">
                                    <i class="fas fa-save me-1"></i>حفظ التقرير
                                </button>
                                <button class="btn btn-info" onclick="scheduleReport()">
                                    <i class="fas fa-clock me-1"></i>جدولة التقرير
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearBuilder()">
                                    <i class="fas fa-trash me-1"></i>مسح الكل
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- Saved Reports -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-folder me-2"></i>التقارير المحفوظة
        </h5>
        <div class="card">
            <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="reportsTable">
                            <thead>
                                <tr>
                                    <th class="text-center">اسم التقرير</th>
                                    <th class="text-center">النوع</th>
                                    <th class="text-center">مصدر البيانات</th>
                                    <th class="text-center">تاريخ الإنشاء</th>
                                    <th class="text-center">آخر تشغيل</th>
                                    <th class="text-center">الحالة</th>
                                    <th class="text-center">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for report in saved_reports %}
                                <tr>
                                    <td class="text-center"><strong>{{ report.name }}</strong></td>
                                    <td class="text-center">
                                        <span class="badge bg-info">{{ report.get_report_type_display }}</span>
                                    </td>
                                    <td class="text-center">{{ report.get_data_source_display }}</td>
                                    <td class="text-center">{{ report.created_at|date:"Y-m-d" }}</td>
                                    <td class="text-center">
                                        {% if report.last_run_at %}
                                            {{ report.last_run_at|timesince }} مضت
                                        {% else %}
                                            لم يتم التشغيل
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-success">{{ report.get_status_display }}</span>
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-outline-primary btn-sm" onclick="runReport({{ report.id }})">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="downloadReport({{ report.id }})">
                                            <i class="fas fa-download"></i>
                                        </button>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteReport({{ report.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted">لا توجد تقارير محفوظة</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    
    <!-- Scheduled Reports -->
    <div class="section-container mb-4">
        <h5 class="section-title">
            <i class="fas fa-calendar-alt me-2"></i>التقارير المجدولة
        </h5>
        <div class="row">
                <div class="col-lg-8 mb-3">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-clock me-2"></i>الجدولة النشطة
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th class="text-center">التقرير</th>
                                            <th class="text-center">التكرار</th>
                                            <th class="text-center">التوقيت</th>
                                            <th class="text-center">آخر تشغيل</th>
                                            <th class="text-center">التشغيل التالي</th>
                                            <th class="text-center">الحالة</th>
                                            <th class="text-center">الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for schedule in scheduled_reports %}
                                        <tr>
                                            <td class="text-center">{{ schedule.report.name }}</td>
                                            <td class="text-center">{{ schedule.get_frequency_display }}</td>
                                            <td class="text-center">{{ schedule.schedule_time|time:"H:i" }}</td>
                                            <td class="text-center">
                                                {% if schedule.last_run_at %}
                                                    {{ schedule.last_run_at|date:"Y-m-d" }}
                                                {% else %}
                                                    لم يتم التشغيل
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if schedule.next_run_at %}
                                                    {{ schedule.next_run_at|date:"Y-m-d H:i" }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if schedule.status == 'ACTIVE' %}
                                                    <span class="badge bg-success">نشط</span>
                                                {% elif schedule.status == 'PAUSED' %}
                                                    <span class="badge bg-warning">متوقف</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">معطل</span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                {% if schedule.status == 'ACTIVE' %}
                                                    <button class="btn btn-outline-warning btn-sm" onclick="pauseSchedule({{ schedule.id }})">
                                                        <i class="fas fa-pause"></i>
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-outline-success btn-sm" onclick="resumeSchedule({{ schedule.id }})">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center text-muted">لا توجد تقارير مجدولة</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-plus me-2"></i>جدولة تقرير جديد
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="scheduleForm">
                                <div class="mb-3">
                                    <label class="form-label">التقرير</label>
                                    <select class="form-select" id="reportToSchedule">
                                        <option value="">اختر تقرير محفوظ</option>
                                        {% for report in saved_reports %}
                                            <option value="{{ report.id }}">{{ report.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">التكرار</label>
                                    <select class="form-select" id="frequency">
                                        <option value="daily">يومياً</option>
                                        <option value="weekly">أسبوعياً</option>
                                        <option value="monthly">شهرياً</option>
                                        <option value="quarterly">ربع سنوي</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">التوقيت</label>
                                    <input type="time" class="form-control" id="scheduleTime" value="09:00">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">إرسال إلى</label>
                                    <input type="email" class="form-control" id="emailRecipients" placeholder="email@example.com">
                                    <small class="text-muted">يمكنك إدخال عدة عناوين مفصولة بفواصل</small>
                                </div>
                                <button type="button" class="btn btn-primary w-100" onclick="createSchedule()">
                                    <i class="fas fa-calendar-plus me-1"></i>إنشاء الجدولة
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/global-table.js' %}"></script>
<script>
// Get CSRF token from meta tag or cookie
function getCSRFToken() {
    // Try meta tag first
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken) {
        return metaToken.getAttribute('content');
    }
    
    // Try hidden input
    const inputToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (inputToken) {
        return inputToken.value;
    }
    
    // Try cookie
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    
    return cookieValue || '';
}

$(document).ready(function() {
    // Initialize DataTable only if there are rows
    const reportsTable = $('#reportsTable tbody tr');
    const hasData = reportsTable.length > 0 && !reportsTable.first().find('td[colspan]').length;
    
    if (typeof GlobalTableManager !== 'undefined' && hasData) {
        GlobalTableManager.initializeTable('reportsTable', {
            order: [[3, 'desc']], // Sort by creation date
            columnDefs: [
                { targets: -1, orderable: false }
            ],
            language: {
                "search": "البحث:",
                "lengthMenu": "عرض _MENU_ تقرير"
            }
        });
    }
});

// Debounce timer for preview updates
let previewTimeout = null;

function debouncedUpdatePreview() {
    if (previewTimeout) {
        clearTimeout(previewTimeout);
    }
    previewTimeout = setTimeout(() => {
        updatePreview();
    }, 800); // Wait 800ms after last change
}

// Report Builder Functions
function loadFields() {
    const dataSource = document.getElementById('dataSource').value;
    const fieldsContainer = document.getElementById('availableFields');
    
    if (!dataSource) {
        fieldsContainer.innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-arrow-up me-2"></i>اختر مصدر البيانات أولاً</div>';
        return;
    }
    
    // Show loading
    fieldsContainer.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>';
    
    // Fetch fields from API
    fetch(`/governance/api/reports/fields/?data_source=${dataSource}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let html = '';
                data.fields.forEach(field => {
                    html += `<div class="field-item" onclick="selectField('${field.name}', '${field.label}')">${field.label}</div>`;
                });
                fieldsContainer.innerHTML = html;
            } else {
                fieldsContainer.innerHTML = '<div class="text-danger text-center py-3">خطأ في تحميل الحقول</div>';
                toastr.error(data.error || 'فشل تحميل الحقول');
            }
        })
        .catch(error => {
            console.error('Error loading fields:', error);
            fieldsContainer.innerHTML = '<div class="text-danger text-center py-3">خطأ في الاتصال</div>';
            toastr.error('حدث خطأ أثناء تحميل الحقول');
        });
}

function selectField(fieldName, fieldLabel) {
    const selectedContainer = document.getElementById('selectedFields');
    const existingFields = selectedContainer.querySelectorAll('.selected-field');
    
    // Check if field already selected
    for (let field of existingFields) {
        if (field.dataset.field === fieldName) {
            return;
        }
    }
    
    // Remove placeholder text if exists
    if (selectedContainer.querySelector('.text-muted')) {
        selectedContainer.innerHTML = '';
    }
    
    // Add selected field
    const fieldElement = document.createElement('span');
    fieldElement.className = 'selected-field';
    fieldElement.dataset.field = fieldName;
    fieldElement.innerHTML = `${fieldLabel} <i class="fas fa-times ms-1" onclick="removeField('${fieldName}')"></i>`;
    
    selectedContainer.appendChild(fieldElement);
    debouncedUpdatePreview();
}

function removeField(fieldName) {
    const fieldElement = document.querySelector(`[data-field="${fieldName}"]`);
    if (fieldElement) {
        fieldElement.remove();
        
        // Add placeholder if no fields left
        const selectedContainer = document.getElementById('selectedFields');
        if (selectedContainer.children.length === 0) {
            selectedContainer.innerHTML = '<div class="text-muted text-center py-4"><i class="fas fa-mouse-pointer me-2"></i>اسحب الحقول هنا أو انقر عليها</div>';
        }
        
        debouncedUpdatePreview();
    }
}

function updatePreview() {
    const selectedFieldsElements = document.querySelectorAll('.selected-field');
    const dataSource = document.getElementById('dataSource').value;
    const reportType = document.getElementById('reportType').value;
    const previewContainer = document.getElementById('chartPreview');
    
    if (selectedFieldsElements.length === 0 || !dataSource) {
        previewContainer.innerHTML = '<div class="text-muted"><i class="fas fa-chart-bar fa-3x mb-2"></i><br>اختر مصدر البيانات والحقول لرؤية المعاينة</div>';
        return;
    }
    
    // Show loading
    previewContainer.innerHTML = '<div class="text-muted"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><br>جاري تحميل المعاينة...</div>';
    
    // Collect selected fields
    const selectedFields = Array.from(selectedFieldsElements).map(el => el.dataset.field);
    
    // Collect filters
    const filters = [];
    document.querySelectorAll('.filter-item').forEach(filterEl => {
        const field = filterEl.querySelector('select:nth-child(1)')?.value;
        const operator = filterEl.querySelector('select:nth-child(2)')?.value;
        const value = filterEl.querySelector('input')?.value;
        if (field && operator && value) {
            filters.push({field, operator, value});
        }
    });
    
    // Prepare request data
    const requestData = {
        data_source: dataSource,
        selected_fields: selectedFields,
        report_type: reportType,
        group_by: document.getElementById('groupBy').value,
        filters: filters
    };
    
    // Call API
    fetch('/governance/api/reports/generate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data && data.data.length > 0) {
            displayPreviewData(data.data, reportType);
        } else {
            previewContainer.innerHTML = '<div class="text-muted"><i class="fas fa-inbox fa-2x mb-2"></i><br>لا توجد بيانات للعرض</div>';
        }
    })
    .catch(error => {
        console.error('Error loading preview:', error);
        previewContainer.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>خطأ في تحميل المعاينة</div>';
    });
}

function displayPreviewData(data, reportType) {
    const previewContainer = document.getElementById('chartPreview');
    
    if (reportType === 'table') {
        // Display as table (first 5 rows)
        const headers = Object.keys(data[0]);
        const previewData = data.slice(0, 5);
        
        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>${headers.map(h => `<th class="text-center small">${h}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
        `;
        
        previewData.forEach(row => {
            tableHtml += '<tr>';
            headers.forEach(header => {
                let value = row[header];
                if (value === null || value === undefined) value = '-';
                else if (typeof value === 'boolean') value = value ? '✓' : '✗';
                else if (typeof value === 'number') value = value.toLocaleString('en-US');
                tableHtml += `<td class="text-center small">${value}</td>`;
            });
            tableHtml += '</tr>';
        });
        
        tableHtml += '</tbody></table></div>';
        if (data.length > 5) {
            tableHtml += `<div class="text-muted text-center mt-2"><small>عرض أول 5 صفوف من ${data.length}</small></div>`;
        }
        
        previewContainer.innerHTML = tableHtml;
    } else {
        // For charts, show icon and data count
        let iconClass = 'fa-chart-bar';
        let iconColor = 'text-primary';
        let chartName = 'رسم بياني';
        
        switch (reportType) {
            case 'bar':
                iconClass = 'fa-chart-bar';
                iconColor = 'text-success';
                chartName = 'رسم بياني عمودي';
                break;
            case 'pie':
                iconClass = 'fa-chart-pie';
                iconColor = 'text-warning';
                chartName = 'رسم دائري';
                break;
            case 'line':
                iconClass = 'fa-chart-line';
                iconColor = 'text-info';
                chartName = 'رسم خطي';
                break;
            case 'summary':
                iconClass = 'fa-list-alt';
                iconColor = 'text-secondary';
                chartName = 'ملخص إحصائي';
                break;
        }
        
        previewContainer.innerHTML = `
            <div class="text-center">
                <i class="fas ${iconClass} fa-3x ${iconColor} mb-2"></i>
                <br><strong>${chartName}</strong>
                <br><span class="text-muted">${data.length} صف</span>
            </div>
        `;
    }
}

function addFilter() {
    const filtersContainer = document.getElementById('filtersContainer');
    const filterHtml = `
        <div class="filter-item mt-2 p-2 border rounded">
            <div class="row">
                <div class="col-4">
                    <select class="form-select form-select-sm">
                        <option>اختر الحقل</option>
                        <option>اسم العميل</option>
                        <option>البريد الإلكتروني</option>
                        <option>تاريخ التسجيل</option>
                    </select>
                </div>
                <div class="col-3">
                    <select class="form-select form-select-sm">
                        <option>يساوي</option>
                        <option>لا يساوي</option>
                        <option>يحتوي على</option>
                        <option>أكبر من</option>
                        <option>أصغر من</option>
                    </select>
                </div>
                <div class="col-4">
                    <input type="text" class="form-control form-control-sm" placeholder="القيمة">
                </div>
                <div class="col-1">
                    <button class="btn btn-outline-danger btn-sm" onclick="this.parentElement.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    filtersContainer.insertAdjacentHTML('beforeend', filterHtml);
}

function generateReport() {
    const selectedFieldsElements = document.querySelectorAll('.selected-field');
    const dataSource = document.getElementById('dataSource').value;
    const reportType = document.getElementById('reportType').value;
    const groupBy = document.getElementById('groupBy').value;
    
    if (!dataSource || selectedFieldsElements.length === 0) {
        toastr.warning('يرجى اختيار مصدر البيانات والحقول المطلوبة');
        return;
    }
    
    // Collect selected fields
    const selectedFields = Array.from(selectedFieldsElements).map(el => el.dataset.field);
    
    // Collect filters
    const filters = [];
    document.querySelectorAll('.filter-item').forEach(filterEl => {
        const field = filterEl.querySelector('select:nth-child(1)')?.value;
        const operator = filterEl.querySelector('select:nth-child(2)')?.value;
        const value = filterEl.querySelector('input')?.value;
        if (field && operator && value) {
            filters.push({field, operator, value});
        }
    });
    
    // Prepare request data
    const requestData = {
        data_source: dataSource,
        selected_fields: selectedFields,
        report_type: reportType,
        group_by: groupBy,
        filters: filters
    };
    
    // Show loading
    toastr.info('جاري إنشاء التقرير...');
    
    // Call API
    fetch('/governance/api/reports/generate/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success(`تم إنشاء التقرير بنجاح! (${data.rows_count} صف)`);
            displayReportResults(data.data, reportType);
        } else {
            toastr.error(data.error || 'فشل إنشاء التقرير');
        }
    })
    .catch(error => {
        console.error('Error generating report:', error);
        toastr.error('حدث خطأ أثناء إنشاء التقرير');
    });
}

function displayReportResults(data, reportType) {
    if (!data || data.length === 0) {
        Swal.fire({
            title: 'نتائج التقرير',
            html: '<div class="text-center text-muted"><i class="fas fa-inbox fa-3x mb-3"></i><br>لا توجد بيانات</div>',
            icon: 'info',
            confirmButtonText: 'حسناً'
        });
        return;
    }
    
    // Build table HTML
    const headers = Object.keys(data[0]);
    let tableHtml = `
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-hover">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                        ${headers.map(h => `<th class="text-center">${h}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Add rows (limit to first 100 for performance)
    const displayData = data.slice(0, 100);
    displayData.forEach(row => {
        tableHtml += '<tr>';
        headers.forEach(header => {
            let value = row[header];
            // Format value
            if (value === null || value === undefined) {
                value = '-';
            } else if (typeof value === 'boolean') {
                value = value ? '<span class="badge bg-success">نعم</span>' : '<span class="badge bg-secondary">لا</span>';
            } else if (typeof value === 'number') {
                value = value.toLocaleString('en-US');
            }
            tableHtml += `<td class="text-center">${value}</td>`;
        });
        tableHtml += '</tr>';
    });
    
    tableHtml += '</tbody></table></div>';
    
    if (data.length > 100) {
        tableHtml += `<div class="text-muted text-center mt-2"><small>عرض أول 100 صف من ${data.length} صف</small></div>`;
    }
    
    // Display in modal
    Swal.fire({
        title: `نتائج التقرير (${data.length} صف)`,
        html: tableHtml,
        width: '80%',
        showCloseButton: true,
        confirmButtonText: 'إغلاق',
        customClass: {
            popup: 'text-end'
        }
    });
}

function saveReport() {
    const selectedFieldsElements = document.querySelectorAll('.selected-field');
    const dataSource = document.getElementById('dataSource').value;
    const reportType = document.getElementById('reportType').value;
    const groupBy = document.getElementById('groupBy').value;
    
    if (!dataSource || selectedFieldsElements.length === 0) {
        toastr.warning('يرجى اختيار مصدر البيانات والحقول المطلوبة');
        return;
    }
    
    // Ask for report name
    Swal.fire({
        title: 'حفظ التقرير',
        html: `
            <input type="text" id="reportName" class="swal2-input" placeholder="اسم التقرير">
            <textarea id="reportDesc" class="swal2-textarea" placeholder="الوصف (اختياري)"></textarea>
        `,
        showCancelButton: true,
        confirmButtonText: 'حفظ',
        cancelButtonText: 'إلغاء',
        preConfirm: () => {
            const name = document.getElementById('reportName').value;
            if (!name) {
                Swal.showValidationMessage('يرجى إدخال اسم التقرير');
                return false;
            }
            return {
                name: name,
                description: document.getElementById('reportDesc').value
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const selectedFields = Array.from(selectedFieldsElements).map(el => el.dataset.field);
            
            // Collect filters
            const filters = [];
            document.querySelectorAll('.filter-item').forEach(filterEl => {
                const field = filterEl.querySelector('select:nth-child(1)')?.value;
                const operator = filterEl.querySelector('select:nth-child(2)')?.value;
                const value = filterEl.querySelector('input')?.value;
                if (field && operator && value) {
                    filters.push({field, operator, value});
                }
            });
            
            const requestData = {
                name: result.value.name,
                description: result.value.description,
                data_source: dataSource,
                selected_fields: selectedFields,
                report_type: reportType,
                group_by: groupBy,
                filters: filters
            };
            
            // Call API
            fetch('/governance/api/reports/save/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('تم حفظ التقرير بنجاح');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(data.error || 'فشل حفظ التقرير');
                }
            })
            .catch(error => {
                console.error('Error saving report:', error);
                toastr.error('حدث خطأ أثناء حفظ التقرير');
            });
        }
    });
}

function scheduleReport() {
    toastr.info('استخدم قسم "جدولة تقرير جديد" في الأسفل');
}

function clearBuilder() {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم مسح جميع الإعدادات',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'نعم، امسح',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('dataSource').value = '';
            document.getElementById('selectedFields').innerHTML = '<div class="text-muted text-center py-4"><i class="fas fa-mouse-pointer me-2"></i>اسحب الحقول هنا أو انقر عليها</div>';
            document.getElementById('availableFields').innerHTML = '<div class="text-muted text-center py-3"><i class="fas fa-arrow-up me-2"></i>اختر مصدر البيانات أولاً</div>';
            document.getElementById('filtersContainer').innerHTML = '<button class="btn btn-outline-primary btn-sm" onclick="addFilter()"><i class="fas fa-plus me-1"></i>إضافة مرشح</button>';
            debouncedUpdatePreview();
            toastr.success('تم مسح الإعدادات');
        }
    });
}

// Report Management Functions
function runReport(reportId) {
    toastr.info('جاري تشغيل التقرير...');
    
    fetch(`/governance/api/reports/${reportId}/run/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            toastr.success(`تم تشغيل التقرير بنجاح! (${data.rows_count} صف)`);
            displayReportResults(data.data, 'table');
        } else {
            toastr.error(data.error || 'فشل تشغيل التقرير');
        }
    })
    .catch(error => {
        console.error('Error running report:', error);
        toastr.error('حدث خطأ أثناء تشغيل التقرير');
    });
}

function downloadReport(reportId) {
    Swal.fire({
        title: 'تحميل التقرير',
        html: `
            <div class="mb-3">
                <label class="form-label">اختر صيغة التحميل</label>
                <select id="downloadFormat" class="form-select">
                    <option value="excel">Excel (.xlsx)</option>
                    <option value="csv">CSV (.csv)</option>
                    <option value="pdf">PDF (.pdf)</option>
                </select>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'تحميل',
        cancelButtonText: 'إلغاء',
        preConfirm: () => {
            return document.getElementById('downloadFormat').value;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const format = result.value;
            toastr.info('جاري تحضير التقرير للتحميل...');
            
            // Create download link
            const downloadUrl = `/governance/api/reports/${reportId}/download/?format=${format}`;
            
            // Trigger download
            fetch(downloadUrl, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('فشل تحميل التقرير');
                }
                return response.blob();
            })
            .then(blob => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${reportId}.${format === 'excel' ? 'xlsx' : format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                toastr.success('تم تحميل التقرير بنجاح');
            })
            .catch(error => {
                console.error('Error downloading report:', error);
                toastr.error('حدث خطأ أثناء تحميل التقرير');
            });
        }
    });
}

function deleteReport(reportId) {
    Swal.fire({
        title: 'هل أنت متأكد؟',
        text: 'سيتم حذف التقرير نهائياً',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'نعم، احذف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/governance/api/reports/${reportId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('تم حذف التقرير بنجاح');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(data.error || 'فشل حذف التقرير');
                }
            })
            .catch(error => {
                console.error('Error deleting report:', error);
                toastr.error('حدث خطأ أثناء حذف التقرير');
            });
        }
    });
}

function pauseSchedule(scheduleId) {
    Swal.fire({
        title: 'إيقاف الجدولة؟',
        text: 'سيتم إيقاف تشغيل التقرير تلقائياً',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، أوقف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/governance/api/reports/schedule/${scheduleId}/pause/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('تم إيقاف الجدولة');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(data.error || 'فشل إيقاف الجدولة');
                }
            })
            .catch(error => {
                console.error('Error pausing schedule:', error);
                toastr.error('حدث خطأ أثناء إيقاف الجدولة');
            });
        }
    });
}

function resumeSchedule(scheduleId) {
    Swal.fire({
        title: 'استئناف الجدولة؟',
        text: 'سيتم تشغيل التقرير تلقائياً حسب الجدول',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، استأنف',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/governance/api/reports/schedule/${scheduleId}/resume/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('تم استئناف الجدولة');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(data.error || 'فشل استئناف الجدولة');
                }
            })
            .catch(error => {
                console.error('Error resuming schedule:', error);
                toastr.error('حدث خطأ أثناء استئناف الجدولة');
            });
        }
    });
}

function createSchedule() {
    const reportToSchedule = document.getElementById('reportToSchedule').value;
    const frequency = document.getElementById('frequency').value;
    const scheduleTime = document.getElementById('scheduleTime').value;
    const emailRecipients = document.getElementById('emailRecipients').value;
    
    if (!reportToSchedule || !frequency || !scheduleTime) {
        toastr.warning('يرجى ملء جميع الحقول المطلوبة');
        return;
    }
    
    Swal.fire({
        title: 'إنشاء جدولة؟',
        text: 'سيتم تشغيل التقرير تلقائياً حسب الجدول المحدد',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، أنشئ',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            const requestData = {
                report_id: reportToSchedule,
                frequency: frequency,
                schedule_time: scheduleTime,
                email_recipients: emailRecipients
            };
            
            fetch('/governance/api/reports/schedule/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('تم إنشاء الجدولة بنجاح');
                    document.getElementById('scheduleForm').reset();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    toastr.error(data.error || 'فشل إنشاء الجدولة');
                }
            })
            .catch(error => {
                console.error('Error creating schedule:', error);
                toastr.error('حدث خطأ أثناء إنشاء الجدولة');
            });
        }
    });
}
</script>
{% endblock %}