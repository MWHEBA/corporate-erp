{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load crispy_forms_tags %}
{% load app_tags %}
{% load custom_filters %}
{% load utils_extras %}
{% load app_tags %}

{% block title %}{{ page_title|default:"فواتير المشتريات" }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/shared-components.css' %}">
<link rel="stylesheet" href="{% static 'css/unified-components.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Page Header المركزي -->
  {% include "shared/page_header.html" %}
  
  <!-- الإحصائيات -->
  <div class="section-container">
    <h5 class="section-title"><i class="fas fa-chart-bar me-2"></i>{% trans "الإحصائيات العامة" %}</h5>
    <div class="row">
      <div class="col-md-6 col-lg-3 mb-4">
        <div class="stats-card stats-card-primary">
          <div class="stats-card-header"></div>
          <div class="stats-card-body">
            <div class="stats-card-icon">
              <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stats-card-title">{% trans "إجمالي الفواتير" %}</div>
            <div class="stats-card-value">{{ purchases|length|default:"0" }}</div>
            <div class="stats-card-unit">{% trans "فاتورة شراء" %}</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 mb-4">
        <div class="stats-card stats-card-success">
          <div class="stats-card-header"></div>
          <div class="stats-card-body">
            <div class="stats-card-icon">
              <i class="fas fa-check-circle"></i>
            </div>
            <div class="stats-card-title">{% trans "فواتير مدفوعة" %}</div>
            <div class="stats-card-value">{{ paid_purchases_count|default:"0" }}</div>
            <div class="stats-card-unit">{% trans "فاتورة" %}</div>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 mb-4">
        <div class="stats-card stats-card-danger">
          <div class="stats-card-header"></div>
          <div class="stats-card-body">
            <div class="stats-card-icon">
              <i class="fas fa-credit-card"></i>
            </div>
            <div class="stats-card-title">{% trans "القيمة الإجمالية" %}</div>
            <div class="stats-card-value">{{ total_amount|smart_float }}</div>
            <small class="text-muted">{% currency_symbol %}</small>
          </div>
        </div>
      </div>
      <div class="col-md-6 col-lg-3 mb-4">
        <div class="stats-card stats-card-info">
          <div class="stats-card-header"></div>
          <div class="stats-card-body">
            <div class="stats-card-icon">
              <i class="fas fa-undo"></i>
            </div>
            <div class="stats-card-title">{% trans "المرتجعات" %}</div>
            <div class="stats-card-value">{{ returned_purchases_count|default:"0" }}</div>
            <div class="stats-card-unit">{% trans "فاتورة مرتجعة" %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- تصفية وبحث -->
  <div class="section-container">
    <h5 class="section-title"><i class="fas fa-filter me-2"></i>{% trans "تصفية وبحث" %}</h5>
    <div class="filter-section mb-4">
      <form method="GET" action="" class="row g-3">
        <div class="col-md-3">
          <label for="supplier" class="form-label">{% trans "المورد" %}</label>
          <select class="form-select" id="supplier" name="supplier">
            <option value="">{% trans "جميع الموردين" %}</option>
            {% for supplier in suppliers %}
            <option value="{{ supplier.id }}" {% if request.GET.supplier == supplier.id|stringformat:"i" %}selected{% endif %}>
              {{ supplier.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <label for="payment_status" class="form-label">{% trans "حالة الدفع" %}</label>
          <select class="form-select" id="payment_status" name="payment_status">
            <option value="">{% trans "الكل" %}</option>
            <option value="paid" {% if request.GET.payment_status == 'paid' %}selected{% endif %}>{% trans "مدفوعة" %}</option>
            <option value="partially_paid" {% if request.GET.payment_status == 'partially_paid' %}selected{% endif %}>{% trans "مدفوعة جزئياً" %}</option>
            <option value="unpaid" {% if request.GET.payment_status == 'unpaid' %}selected{% endif %}>{% trans "غير مدفوعة" %}</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="date_from" class="form-label">{% trans "من تاريخ" %}</label>
          <input type="text" class="form-control" id="date_from" name="date_from" data-date-picker placeholder="من تاريخ" value="{{ request.GET.date_from }}">
        </div>
        <div class="col-md-2">
          <label for="date_to" class="form-label">{% trans "إلى تاريخ" %}</label>
          <input type="text" class="form-control" id="date_to" name="date_to" data-date-picker placeholder="إلى تاريخ" value="{{ request.GET.date_to }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-search me-2"></i>{% trans "بحث" %}
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- قائمة فواتير المشتريات -->
  <div class="section-container">
    <h5 class="section-title"><i class="fas fa-list me-2"></i>{% trans "قائمة فواتير المشتريات" %}</h5>
    {% include "components/data_table.html" with table_id="purchases-table" headers=table_headers data=table_data primary_key="id" empty_message="لا توجد فواتير مشتريات متاحة" %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- مكتبة SheetJS لتصدير البيانات إلى Excel بدعم كامل للغة العربية -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- استخدام مكتبة DataTables من ملف datatables.min.js الموجود -->
<script src="{% static 'js/global-table.js' %}"></script>
<script>
  $(document).ready(function() {
    {% if table_data %}
    // تهيئة جدول المشتريات
    if (typeof GlobalTableManager !== 'undefined') {
        GlobalTableManager.initializeTable('purchases-table', {
            order: [[1, 'desc']], // ترتيب حسب التاريخ تنازلياً
            columnDefs: [
                { targets: -1, orderable: false }, // عمود الإجراءات
                { targets: [0, 1, 3, 4, 5, 6, 7, 8, 9], className: 'text-center' }
            ]
        });
    }
    {% endif %}
  });
  
  // دالة تأكيد الحذف
  function confirmDelete(purchaseId) {
      if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟ سيتم التراجع عن جميع العمليات المحاسبية والمخزنية المرتبطة بها.')) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/purchase/${purchaseId}/delete/`;
          
          const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
          if (csrfToken) {
              const csrfInput = document.createElement('input');
              csrfInput.type = 'hidden';
              csrfInput.name = 'csrfmiddlewaretoken';
              csrfInput.value = csrfToken.value;
              form.appendChild(csrfInput);
          }
          
          document.body.appendChild(form);
          form.submit();
      }
  }
</script>
{% endblock %} 