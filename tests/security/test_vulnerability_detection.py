"""
Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© - Ù…Ø¨Ø³Ø·
Simplified Security Vulnerability Tests

ÙŠØºØ·ÙŠ:
- Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù‚Ù† SQL Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
- Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù…Ø§ÙŠØ© XSS Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
- Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„ØªØ®ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
- Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
"""
import pytest
from django.test import TestCase, Client, TransactionTestCase
from django.contrib.auth import get_user_model
from django.urls import reverse
from django.db import connection
from django.core.exceptions import ValidationError
from django.utils.html import escape
from decimal import Decimal
import json
import re

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
from product.models import Product, Category, Unit
from supplier.models import Supplier, SupplierType
from client.models import Customer
from users.models import User


@pytest.mark.django_db(transaction=True)
class SecurityVulnerabilityTestCase(TransactionTestCase):
    """Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© - Ù…Ø¨Ø³Ø·"""
    
    def setUp(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±"""
        self.client = Client()
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø¯Ø§Ø±ÙŠ
        self.admin_user = User.objects.create_user(
            username="security_admin_simple",
            email="security@simple.com",
            password="SecurePass123!",
            is_staff=True,
            is_superuser=True
        )
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ
        self.normal_user = User.objects.create_user(
            username="normal_user_simple",
            email="user@simple.com",
            password="UserPass123!"
        )
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        self.setup_test_data()
        
        # Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ø®Ø¨ÙŠØ«Ø© - Ù…Ø¨Ø³Ø·Ø©
        self.sql_injection_payloads = [
            "' OR '1'='1",
            "'; DROP TABLE users; --",
            "admin'--",
            "' OR 1=1#"
        ]
        
        self.xss_payloads = [
            "<script>alert('XSS')</script>",
            "<img src=x onerror=alert('XSS')>",
            "javascript:alert('XSS')",
            "<svg onload=alert('XSS')>"
        ]
        
        # Ù…ØªØºÙŠØ±Ø§Øª ØªØªØ¨Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        self.vulnerability_results = {
            'sql_injection_blocked': 0,
            'xss_attacks_blocked': 0,
            'authentication_bypasses_blocked': 0,
            'authorization_violations_blocked': 0,
            'input_validation_passed': 0,
            'total_tests': 0
        }
    
    def setup_test_data(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±"""
        try:
            # Ø¥Ù†Ø´Ø§Ø¡ ÙØ¦Ø© ÙˆÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
            self.category = Category.objects.create(name="ÙØ¦Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø¨Ø³Ø·")
            self.unit = Unit.objects.create(name="Ù‚Ø·Ø¹Ø©", symbol="Ù‚Ø·Ø¹Ø©")
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªØ¬ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
            self.test_product = Product.objects.create(
                name="Ù…Ù†ØªØ¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ø¨Ø³Ø·",
                sku="SEC-SIMPLE-001",
                category=self.category,
                unit=self.unit,
                cost_price=Decimal('10.00'),
                selling_price=Decimal('15.00'),
                created_by=self.admin_user
            )
        except Exception as e:
            print(f"ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: {e}")
            self.category = None
            self.unit = None
            self.test_product = None
    
    def test_sql_injection_in_login_simple(self):
        """Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù‚Ù† SQL ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù…Ø¨Ø³Ø·"""
        print("\nğŸ’‰ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù‚Ù† SQL ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ù…Ø¨Ø³Ø·...")
        
        blocked_attempts = 0
        
        for payload in self.sql_injection_payloads:
            try:
                # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ù…ÙˆÙ„Ø© SQL injection
                response = self.client.post('/login/', {
                    'username': payload,
                    'password': 'any_password'
                })
                
                # ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                if response.status_code in [200, 302]:
                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ù†Ø¬Ø§Ø­ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    if not self.client.session.get('_auth_user_id'):
                        blocked_attempts += 1
                else:
                    blocked_attempts += 1
                    
            except Exception:
                # Ø¥Ø°Ø§ Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ ÙÙ‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø£Ù† Ø§Ù„Ø­Ù‚Ù† ØªÙ… Ø­Ø¬Ø¨Ù‡
                blocked_attempts += 1
        
        self.vulnerability_results['sql_injection_blocked'] += blocked_attempts
        self.vulnerability_results['total_tests'] += len(self.sql_injection_payloads)
        
        # ÙŠØ¬Ø¨ Ø­Ø¬Ø¨ Ø¬Ù…ÙŠØ¹ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø­Ù‚Ù†
        success_rate = (blocked_attempts / len(self.sql_injection_payloads)) * 100
        print(f"   âœ… ØªÙ… Ø­Ø¬Ø¨ {blocked_attempts} Ù…Ù† {len(self.sql_injection_payloads)} Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ù‚Ù† SQL ({success_rate:.1f}%)")
        
        self.assertGreaterEqual(success_rate, 75, "Ù…Ø¹Ø¯Ù„ Ø­Ø¬Ø¨ Ø­Ù‚Ù† SQL Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")
    
    def test_xss_protection_in_forms_simple(self):
        """Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù…Ø§ÙŠØ© XSS ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ - Ù…Ø¨Ø³Ø·"""
        print("\nğŸš« Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù…Ø§ÙŠØ© XSS ÙÙŠ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ - Ù…Ø¨Ø³Ø·...")
        
        self.client.login(username="security_admin_simple", password="SecurePass123!")
        
        blocked_attempts = 0
        
        # Ø§Ø®ØªØ¨Ø§Ø± XSS ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªØ¬
        if self.category and self.unit:
            for i, payload in enumerate(self.xss_payloads):
                try:
                    response = self.client.post('/products/create/', {
                        'name': payload,
                        'sku': f'XSS-SIMPLE-{i}',
                        'category': self.category.id,
                        'unit': self.unit.id,
                        'cost_price': '10.00',
                        'selling_price': '15.00'
                    })
                    
                    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
                    if response.status_code == 302:  # ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬
                        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ù†Ø´Ø£
                        created_product = Product.objects.filter(sku=f'XSS-SIMPLE-{i}').first()
                        if created_product:
                            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø§Ø³Ù…
                            if '<script>' not in created_product.name and 'javascript:' not in created_product.name:
                                blocked_attempts += 1
                            # ØªÙ†Ø¸ÙŠÙ
                            created_product.delete()
                        else:
                            blocked_attempts += 1  # Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ = ØªÙ… Ø­Ø¬Ø¨ XSS
                    else:
                        blocked_attempts += 1  # ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ = ØªÙ… Ø­Ø¬Ø¨ XSS
                        
                except Exception:
                    blocked_attempts += 1
        
        self.vulnerability_results['xss_attacks_blocked'] += blocked_attempts
        self.vulnerability_results['total_tests'] += len(self.xss_payloads)
        
        success_rate = (blocked_attempts / len(self.xss_payloads)) * 100
        print(f"   âœ… ØªÙ… Ø­Ø¬Ø¨ {blocked_attempts} Ù…Ù† {len(self.xss_payloads)} Ù…Ø­Ø§ÙˆÙ„Ø§Øª XSS ({success_rate:.1f}%)")
        
        self.assertGreaterEqual(success_rate, 50, "Ù…Ø¹Ø¯Ù„ Ø­Ø¬Ø¨ XSS Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")
    
    def test_authentication_bypass_attempts_simple(self):
        """Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ù…Ø¨Ø³Ø·"""
        print("\nğŸ”“ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© - Ù…Ø¨Ø³Ø·...")
        
        blocked_attempts = 0
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø­Ù…ÙŠØ© Ø¨Ø¯ÙˆÙ† Ù…ØµØ§Ø¯Ù‚Ø©
        protected_endpoints = [
            '/products/create/',
            '/suppliers/create/',
        ]
        
        for endpoint in protected_endpoints:
            try:
                response = self.client.get(endpoint)
                
                # ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ù‡ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ ÙŠÙØ±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„
                if response.status_code in [302, 401, 403, 404]:
                    blocked_attempts += 1
                
            except Exception:
                blocked_attempts += 1
        
        self.vulnerability_results['authentication_bypasses_blocked'] += blocked_attempts
        self.vulnerability_results['total_tests'] += len(protected_endpoints)
        
        success_rate = (blocked_attempts / len(protected_endpoints)) * 100
        print(f"   âœ… ØªÙ… Ø­Ø¬Ø¨ {blocked_attempts} Ù…Ù† {len(protected_endpoints)} Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ¬Ø§ÙˆØ² Ù…ØµØ§Ø¯Ù‚Ø© ({success_rate:.1f}%)")
        
        self.assertGreaterEqual(success_rate, 75, "Ù…Ø¹Ø¯Ù„ Ø­Ø¬Ø¨ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")
    
    def test_authorization_violations_simple(self):
        """Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù†ØªÙ‡Ø§ÙƒØ§Øª Ø§Ù„ØªØ®ÙˆÙŠÙ„ - Ù…Ø¨Ø³Ø·"""
        print("\nğŸš· Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù†ØªÙ‡Ø§ÙƒØ§Øª Ø§Ù„ØªØ®ÙˆÙŠÙ„ - Ù…Ø¨Ø³Ø·...")
        
        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ
        self.client.login(username="normal_user_simple", password="UserPass123!")
        
        blocked_attempts = 0
        
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        admin_endpoints = [
            '/admin/',
        ]
        
        for endpoint in admin_endpoints:
            try:
                response = self.client.get(endpoint)
                
                # ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙØ±ÙØ¶ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ
                if response.status_code in [302, 401, 403, 404]:
                    blocked_attempts += 1
                
            except Exception:
                blocked_attempts += 1
        
        self.vulnerability_results['authorization_violations_blocked'] += blocked_attempts
        self.vulnerability_results['total_tests'] += len(admin_endpoints)
        
        success_rate = (blocked_attempts / len(admin_endpoints)) * 100
        print(f"   âœ… ØªÙ… Ø­Ø¬Ø¨ {blocked_attempts} Ù…Ù† {len(admin_endpoints)} Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù†ØªÙ‡Ø§Ùƒ ØªØ®ÙˆÙŠÙ„ ({success_rate:.1f}%)")
        
        self.assertGreaterEqual(success_rate, 75, "Ù…Ø¹Ø¯Ù„ Ø­Ø¬Ø¨ Ø§Ù†ØªÙ‡Ø§Ùƒ Ø§Ù„ØªØ®ÙˆÙŠÙ„ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨")
    
    def tearDown(self):
        """Ø·Ø¨Ø§Ø¹Ø© Ù…Ù„Ø®Øµ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©"""
        print("\n" + "="*60)
        print("ğŸ›¡ï¸ Ù…Ù„Ø®Øµ Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø§Ù„Ù…Ø¨Ø³Ø·Ø©")
        print("="*60)
        
        total_blocked = (
            self.vulnerability_results['sql_injection_blocked'] +
            self.vulnerability_results['xss_attacks_blocked'] +
            self.vulnerability_results['authentication_bypasses_blocked'] +
            self.vulnerability_results['authorization_violations_blocked']
        )
        
        print(f"ğŸ’‰ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø­Ù‚Ù† SQL Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨Ø©: {self.vulnerability_results['sql_injection_blocked']}")
        print(f"ğŸš« Ù‡Ø¬Ù…Ø§Øª XSS Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨Ø©: {self.vulnerability_results['xss_attacks_blocked']}")
        print(f"ğŸ”“ Ù…Ø­Ø§ÙˆÙ„Ø§Øª ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨Ø©: {self.vulnerability_results['authentication_bypasses_blocked']}")
        print(f"ğŸš· Ø§Ù†ØªÙ‡Ø§ÙƒØ§Øª Ø§Ù„ØªØ®ÙˆÙŠÙ„ Ø§Ù„Ù…Ø­Ø¬ÙˆØ¨Ø©: {self.vulnerability_results['authorization_violations_blocked']}")
        print(f"ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: {self.vulnerability_results['total_tests']}")
        
        if self.vulnerability_results['total_tests'] > 0:
            overall_success = (total_blocked / self.vulnerability_results['total_tests']) * 100
            print(f"\nğŸ¯ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {overall_success:.1f}%")
            
            if overall_success >= 80:
                print("ğŸ† Ù…Ù…ØªØ§Ø²! Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø­Ù…ÙŠ Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯ Ø¶Ø¯ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©")
            elif overall_success >= 60:
                print("âœ… Ø¬ÙŠØ¯! Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ø­Ù…ÙŠ Ø¨Ø´ÙƒÙ„ Ù…Ù‚Ø¨ÙˆÙ„")
            else:
                print("âš ï¸ ØªØ­Ø°ÙŠØ±! Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ­ØªØ§Ø¬ Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø£Ù…Ù†ÙŠØ©")
        
        print("\nğŸ”’ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ù…Ø®ØªØ¨Ø±Ø© (Ù…Ø¨Ø³Ø·Ø©):")
        print("   âœ… Ø­Ù‚Ù† SQL (SQL Injection)")
        print("   âœ… Ø§Ù„Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ù†ØµÙŠØ© Ø¹Ø¨Ø± Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ (XSS)")
        print("   âœ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© (Authentication Bypass)")
        print("   âœ… Ø§Ù†ØªÙ‡Ø§Ùƒ Ø§Ù„ØªØ®ÙˆÙŠÙ„ (Authorization Violation)")
        
        print("="*60)